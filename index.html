<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Currency Formats Reference</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    /* 1. VARIABLES AND BASE STYLES */
    :root {
      /* Light Theme */
      --color-bg: #F9FAFB; --color-surface: #FFFFFF; --color-surface-hover: rgba(59, 130, 246, 0.1); --color-primary: #3B82F6; --color-primary-a: rgba(59, 130, 246, 0.15); --color-button-text: #FFFFFF; --color-text-primary: #1F2937; --color-text-secondary: #6B7280; --color-border: #E5E7EB;
      --color-success: #16A34A;
      --color-danger: #EF4444;
      --color-warning: #F59E0B;
      --color-unique: #9C27B0;
      --color-active-col-bg: rgba(59, 130, 246, 0.1);
      --color-row-even-bg: #F3F4F6;

      /* Muted Tag Colors (Light Theme) */
      --tag-euro-bg: #EFF6FF; --tag-euro-text: #1E40AF; --tag-euro-border: #BFDBFE;
      --tag-dollar-bg: #F0FDF4; --tag-dollar-text: #166534; --tag-dollar-border: #BBF7D0;
      --tag-other-bg: #EEF2FF; --tag-other-text: #3730A3; --tag-other-border: #C7D2FE;
      --tag-closed-bg: #F3F4F6; --tag-closed-text: #374151; --tag-closed-border: #E5E7EB; /* MODIFIED: Contrast fix */
    }
    [data-theme="dark"] {
      /* Dark Theme */
      --color-bg: #111827; --color-surface: #1F2937; --color-surface-hover: #374151; --color-primary: #00BCD4; --color-primary-a: rgba(96, 165, 250, 0.15); --color-button-text: #111827; --color-text-primary: #E9FAFA; --color-text-secondary: #B0BEC5; --color-border: #374151;
      --color-success: #4AAA80;
      --color-danger: #FCA5A5;
      --color-warning: #FFC107;
      --color-unique: #EF4444;
      --color-active-col-bg: rgba(96, 165, 250, 0.1);
      --color-row-even-bg: var(--color-bg);

      /* Muted Tag Colors (Dark Theme) */
      --tag-euro-bg: #1E293B; --tag-euro-text: #93C5FD; --tag-euro-border: #334155;
      --tag-dollar-bg: #1F2923; --tag-dollar-text: #86EFAC; --tag-dollar-border: #223B2C;
      --tag-other-bg: #252336; --tag-other-text: #A5B4FC; --tag-other-border: #393653;
      --tag-closed-bg: #374151; --tag-closed-text: #D1D5DB; --tag-closed-border: #4B5563; /* MODIFIED: Contrast fix */
    }
    :root {
      --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; --space-2: 14px; --space-4: 24px;
      --thumb-size: 40px; --track-padding: 3px; --track-width: 88px;
      --thumb-translate: calc(var(--track-width) - var(--thumb-size) - (var(--track-padding) * 2));
    }

    /* 2. MAIN PAGE & SEMANTIC STYLES */
    body { font-family: var(--font-main); line-height: 1.5; background-color: var(--color-bg); color: var(--color-text-primary); margin: 0; padding: var(--space-2); transition: background-color 0.3s ease, color 0.3s ease; }
    .container { max-width: 1400px; margin-left: auto; margin-right: auto; }
    header#controls-section { position: sticky; top: 0; z-index: 20; background: var(--color-bg); padding: 12px 0; margin-bottom: 12px; }
    main .container { background: var(--color-surface); padding: var(--space-4); border-radius: 12px; border: 1px solid var(--color-border); transition: background-color 0.3s ease, border-color 0.3s ease; }
    footer { text-align: center; margin-top: 3rem; font-size: 0.9em; }
    footer p { margin: 0.25rem 0; }
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

    /* 3. CONTROL ELEMENT STYLES */
    .controls-panel { display: flex; gap: 1em; align-items: center; flex-wrap: wrap; }
    .control-btn { position: relative; background-color: var(--color-surface); border: 1px solid var(--color-border); padding: 0; border-radius: 8px; color: var(--color-text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; height: 48px; width: 48px; flex-shrink: 0; transition: all 0.2s ease; }
    .control-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .control-btn.is-active-filter { border-color: var(--color-primary); color: var(--color-primary); background-color: var(--color-primary-a); }
    .control-btn svg { width: 24px; height: 24px; pointer-events: none; }
    #core-cols-toggle-btn .icon-eye-off { display: none; }
    #core-cols-toggle-btn .icon-eye { display: block; }
    #core-cols-toggle-btn[data-state="hidden"] .icon-eye { display: none; }
    #core-cols-toggle-btn[data-state="hidden"] .icon-eye-off { display: block; }
    #toggleClosedBtn .icon-hide-closed { display: none; }
    #toggleClosedBtn[data-state="shown"] { border-color: var(--color-warning); color: var(--color-warning); background-color: rgba(245, 158, 11, 0.1); }
    #toggleClosedBtn[data-state="shown"] .icon-show-closed { display: none; }
    #toggleClosedBtn[data-state="shown"] .icon-hide-closed { display: block; }

    #searchInput { flex-grow: 1; min-width: 200px; padding: 12px 15px; border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: var(--color-bg); color: var(--color-text-primary); border: 1px solid var(--color-border); height: 48px; transition: all 0.2s ease; }
    #searchInput:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-primary-a); }
    .filter-count { position: absolute; top: -5px; right: -5px; background-color: var(--color-primary); color: var(--color-button-text); border-radius: 50%; width: 20px; height: 20px; font-size: 12px; font-weight: 700; line-height: 20px; text-align: center; pointer-events: none; transform: scale(0); transition: transform 0.2s ease-out; }
    .filter-count:not(:empty) { transform: scale(1); }
    .theme-toggle { display: inline-flex; align-items: center; position: relative; height: 48px; width: var(--track-width); border-radius: 8px; border: 1px solid var(--color-border); background-color: var(--color-surface); cursor: pointer; transition: background-color 0.3s ease; padding: 0; flex-shrink: 0; }
    .theme-toggle:hover { border-color: var(--color-primary); }
    .theme-toggle-thumb { position: absolute; top: var(--track-padding); left: var(--track-padding); height: var(--thumb-size); width: var(--thumb-size); border-radius: 6px; background-color: var(--color-bg); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease, background-color 0.3s ease; transform: translateX(0); color: var(--color-text-primary); }
    .theme-toggle-thumb svg { width: 22px; height: 22px; }
    .theme-toggle .icon-sun { display: none; }
    .theme-toggle .icon-moon { display: block; }
    .theme-toggle[aria-checked="true"] { background-color: var(--color-primary); border-color: var(--color-primary); }
    .theme-toggle[aria-checked="true"] .theme-toggle-thumb { transform: translateX(var(--thumb-translate)); background-color: #FFFFFF; color: var(--color-primary); border-color: transparent; }
    .theme-toggle[aria-checked="true"] .icon-sun { display: block; }
    .theme-toggle[aria-checked="true"] .icon-moon { display: none; }

    /* NEW: Quick Filters */
    .quick-filters { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .quick-filter-btn { background-color: var(--color-surface); border: 1px solid var(--color-border); color: var(--color-text-secondary); border-radius: 16px; padding: 4px 14px; font-size: 14px; cursor: pointer; transition: all 0.2s ease; }
    .quick-filter-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .quick-filter-btn.is-active { background-color: var(--color-primary); color: var(--color-button-text); border-color: var(--color-primary); font-weight: 600; }

    /* 4. DROPDOWN & ACCORDION STYLES */
    .dropdown-wrapper { position: relative; }
    .dropdown-menu { display: none; position: absolute; top: 110%; right: 0; background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 8px; z-index: 100; min-width: 280px; max-height: 450px; overflow-y: auto; }
    .dropdown-menu.is-open { display: block; }
    #filter-dropdown ul { list-style: none; margin: 0; padding: 0; }
    #filter-reset-all { font-weight: 700; cursor: pointer; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--color-primary); background-color: var(--color-primary-a); color: var(--color-primary); text-align: center; margin-bottom: 12px; transition: all 0.2s ease; display: block; width: 100%; box-sizing: border-box; }
    #filter-reset-all:hover { background-color: var(--color-primary); color: var(--color-button-text); }
    .filter-accordion-item:not(:last-child) { border-bottom: 1px solid var(--color-border); }
    .filter-accordion-header { background: none; border: none; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 12px 6px; cursor: pointer; text-align: left; }
    .filter-accordion-header h3 { margin: 0; font-size: 1.05em; color: var(--color-text-primary); }
    .filter-accordion-toggle { transition: transform 0.3s ease; color: var(--color-text-secondary); }
    .filter-accordion-toggle svg { width: 20px; height: 20px; }
    .filter-accordion-item.is-open .filter-accordion-toggle { transform: rotate(180deg); color: var(--color-primary); }
    .filter-accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
    .filter-accordion-content .filter-group-list { padding: 4px 6px 12px 6px; }
    #filter-dropdown .filter-group-select-all { font-weight: 600; color: var(--color-primary); }
    #filter-dropdown .filter-value-item label { display: block; width: 100%; cursor: pointer; padding: 6px 12px; border-radius: 4px; }
    #filter-dropdown .filter-value-item:hover { background-color: var(--color-surface-hover); }
    #filter-dropdown .filter-value-item input[type="checkbox"] { margin-right: 12px; vertical-align: middle; }
    
    /* 5. TABLE STYLES & LEGEND */
    .table-header-controls { display: flex; justify-content: flex-end; margin-bottom: 12px; }
    .legend-wrapper { position: relative; }
    .legend-toggle { background: none; border: none; padding: 4px; cursor: help; color: var(--color-text-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .legend-toggle:hover, .legend-toggle:focus { color: var(--color-primary); background-color: var(--color-primary-a); outline: none; }
    .legend-popover { visibility: hidden; opacity: 0; position: absolute; bottom: 120%; right: 0; background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 12px 16px; z-index: 110; width: max-content; transition: opacity 0.2s, visibility 0.2s; }
    .legend-toggle:hover + .legend-popover, .legend-toggle:focus + .legend-popover, .legend-popover:hover { visibility: visible; opacity: 1; }
    .legend-popover h4 { margin: 0 0 8px 0; font-size: 1em; color: var(--color-text-primary); }
    .legend-popover ul { margin: 0; padding: 0 0 0 16px; list-style-type: '» '; }
    .legend-popover li { padding-left: 8px; margin-bottom: 4px; }

    .table-wrapper { overflow-x: auto; border: 1px solid var(--color-border); border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; }
    th { font-weight: 600; cursor: pointer; user-select: none; white-space: normal; vertical-align: middle; text-align: center; padding: 8px 6px; border-bottom: 1px solid var(--color-border); }
    td { padding: 10px 12px; text-align: center; vertical-align: middle; border-bottom: 1px solid var(--color-border); }
    thead { position: sticky; top: 0; z-index: 10; background-color: var(--color-surface); color: var(--color-text-primary); }
    th > div { display: flex; align-items: center; justify-content: center; }
    td:not(:last-child) { border-right: 1px solid var(--color-border); }
    th:not(:last-child) { border-right: 1px solid var(--color-border); }
    tbody tr:last-child td { border-bottom: none; }
    .sort-indicator { transition: color 0.2s ease; margin-right: 0.5em; font-size: 1.2em; }
    tbody tr:nth-child(even) { background-color: var(--color-row-even-bg); }
    tbody tr:hover { background-color: var(--color-surface-hover); }
    th.is-active { font-weight: 900; color: var(--color-primary); }
    tbody tr td.is-active { background-color: var(--color-active-col-bg); }
    .is-hidden { display: none !important; }
    
    .currency-tag { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.9em; font-weight: 700; line-height: 1.2; border: 1px solid transparent; text-align: center; min-width: 50px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    .currency-tag--euro-active { background-color: var(--tag-euro-bg); color: var(--tag-euro-text); border-color: var(--tag-euro-border); }
    .currency-tag--dollar-family { background-color: var(--tag-dollar-bg); color: var(--tag-dollar-text); border-color: var(--tag-dollar-border); }
    .currency-tag--other { background-color: var(--tag-other-bg); color: var(--tag-other-text); border-color: var(--tag-other-border); }
    .currency-tag--note-secondary { background-color: var(--tag-closed-bg); color: var(--tag-closed-text); border-color: var(--tag-closed-border); }

    .text-success { color: var(--color-success); } .text-danger { color: var(--color-danger); } .text-warning { color: var(--color-warning); } .text-unique { color: var(--color-unique); } .text-note-secondary { color: var(--color-text-secondary); }
    
    th:nth-child(1), td:nth-child(1) { width: 8%; text-align: center;}
    td:nth-child(2), td:nth-child(3), td:nth-child(4) { text-align: left; }
    th:nth-child(2) { width: 20%; } th:nth-child(3) { width: 20%; } th:nth-child(4) { width: 25%; white-space: normal;}
    th:nth-child(5), td:nth-child(5), th:nth-child(6), td:nth-child(6), th:nth-child(7), td:n th:nth-child(7), th:nth-child(8), td:nth-child(8) { width: 1%; text-align: center; white-space: nowrap; }

    /* 6. RESPONSIVENESS - CARD LAYOUT */
    @media (max-width: 820px) {
      .controls-panel { gap: 0.75em; } 
      #searchInput { width: 100%; order: 10; margin-top: 0.5em; }
    
      .table-wrapper { border: none; }
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tbody tr { border: 1px solid var(--color-border); border-radius: 8px; margin-bottom: 1rem; background-color: var(--color-surface); }
      tbody tr:nth-child(even) { background-color: var(--color-surface); }
      td { border: none; border-bottom: 1px solid var(--color-border); position: relative; padding-left: 50%; text-align: right; display: flex; justify-content: flex-end; align-items: center; min-height: 44px; }
      td:last-child { border-bottom: none; }
      td::before { content: attr(data-label); position: absolute; left: 12px; width: 45%; padding-right: 10px; white-space: nowrap; font-weight: 600; text-align: left; color: var(--color-text-secondary); }
      td:nth-child(1) { padding: 12px; font-weight: 700; font-size: 1.1em; background-color: var(--color-row-even-bg); border-radius: 8px 8px 0 0; justify-content: center; }
      td:nth-child(1)::before { display: none; }
    }
  </style>
</head>
<body>

<header id="controls-section">
    <div class="container">
        <div class="controls-panel">
            <button id="scrollToTopBtn" class="control-btn" title="Scroll to top" aria-label="Scroll to top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></button>
            <button id="theme-switcher" class="theme-toggle" role="switch" title="Switch color theme"> <span class="theme-toggle-thumb"> <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg> <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> </span> </button>
            <input type="search" id="searchInput" placeholder="Search currency formats...">
            <button id="core-cols-toggle-btn" class="control-btn" title="Toggle technical columns" aria-label="Toggle technical columns visibility"> <svg class="icon-eye" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg> <svg class="icon-eye-off" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg> </button>
            <button id="toggleClosedBtn" class="control-btn" title="Toggle CLOSED rows" aria-label="Toggle visibility of closed rows">
                <svg class="icon-show-closed" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1"></path><rect x="3" y="8" width="18" height="12" rx="2" ry="2"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
                <svg class="icon-hide-closed" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
            </button>
            <div class="dropdown-wrapper">
              <button id="filter-btn" class="control-btn" title="Filter by value" aria-label="Filter table by selected value">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                  <span class="filter-count"></span>
              </button>
              <div id="filter-dropdown" class="dropdown-menu">
                  <ul id="filter-list"></ul>    
              </div>
            </div>
        </div>
        <!-- NEW: Quick Filters Panel -->
        <div class="quick-filters" id="quickFiltersPanel">
            <button class="quick-filter-btn" data-filter-value="EUR">Only EUR</button>
            <button class="quick-filter-btn" data-filter-value="USD AUD CAD NZD">Dollar Family</button>
            <button class="quick-filter-btn" data-filter-value="SPC">Space Separator</button>
        </div>
    </div> 
</header>

<main>
    <div class="container">
        <!-- NEW: Table Header Controls with Legend -->
        <div class="table-header-controls">
            <div class="legend-wrapper">
                <button class="legend-toggle" aria-describedby="table-legend">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </button>
                <div id="table-legend" class="legend-popover" role="tooltip">
                    <h4>Technical Column Legend</h4>
                    <ul>
                        <li><strong>Position:</strong> 🅱️ - Symbol Before amount</li>
                        <li><strong>Decimal:</strong> ● - DOT used as separator</li>
                        <li><strong>Thds.:</strong> ● - DOT used as separator</li>
                        <li><strong>Thds.:</strong> <span class="text-warning">Nbsp</span> - Non-breaking space used</li>
                        <li><strong>Thds.:</strong> <span class="text-unique">UNQ</span> - Unique separator (e.g., apostrophe)</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="glossaryTable">
                <thead>
                    <tr>
                        <th data-column-index="1" data-column-id="valuta"><div><span class="sort-indicator" aria-hidden="true">↕</span><span>Code</span></div></th>
                        <th data--index="2" data-column-id="country"><div><span class="sort-indicator" aria-hidden="true">↕</span><span>Country</span></div></th>
                        <th data-column-index="3" data-column-id="example"><div><span class="sort-indicator" aria-hidden="true">↕</span><span>Example</span></div></th>
                        <th data-column-index="4" data-column-id="note"><div><span class="sort-indicator" aria-hidden="true">↕</span><span>Note</span></div></th>
                        <th data-column-index="5" data-column-id="local" data-is-core="true"><div><span class="sort-indicator" aria-hidden="true">↕</span><span>Local</span></div></th>
                        <th data-column-index="6" data-column-id="symPos" data-is-core="true"><div><span class="sort-indicator" aria-hidden="true">↕</span><span>Position</span></div></th>
                        <th data-column-index="7" data-column-id="decSep" data-is-core="true"><div><span class="sort-indicator" aria-hidden="true">↕</span><span>Decimal</span></div></th>
                        <th data-column-index="8" data-column-id="tdsSep" data-is-core="true"><div><span class="sort-indicator" aria-hidden="true">↕</span><span>Thds.</span></div></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer>
    <p>Generated by an autonomous AI-Agent: MAE OMA-II</p>
    <p style="color: var(--color-primary); font-weight: bold;">© 2025 McBile AI-Engine</p>
</footer>

<script>
// IIFE to avoid polluting global scope
(() => {
    // --- DATA SOURCE ---
    const currencyData = [
        {valuta:"EUR",country:"🇦🇩 Andorra (AD)",example:"1.234,56 €",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"AUD",country:"🇦🇺 Australia (AU)",example:"$1,234.56",note:"External: A$",local:"en-AU",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"EUR",country:"🇦🇹 Austria (AT)",example:"1.234,56 €",note:"",local:"de",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"EUR",country:"🇧🇪 Belgium (BE-FR)",example:"1 234,56 €",note:"",local:"fr",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"EUR",country:"🇧🇪 Belgium (BE-NL)",example:"€ 1.234,56",note:"Nbsp after €",local:"nl",symPos:"Before",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"BRL",country:"🇧🇷 Brazil (BR)",example:"R$ 1.234,56",note:"CLOSED NON EU",local:"pt-BR",symPos:"Before",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"TRY",country:"🇹🇷 Turkey (TR)",example:"1.234,56 TL",note:"CLOSED NON EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"BGN",country:"🇧🇬 Bulgaria (BG)",example:"1 234,56 лв.",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"closed"},
        {valuta:"CAD",country:"🇨🇦 Canada (CA-EN)",example:"$1,234.56",note:"External: CA$",local:"en-CA",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"CAD",country:"🇨🇦 Canada (CA-FR)",example:"$1,234.56",note:"External: CA$",local:"fr-CA",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"EUR",country:"🇭🇷 Croatia (HR)",example:"1.234,56 €",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"EUR",country:"🇨🇾 Cyprus (CY)",example:"1.234,56 €",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"CZK",country:"🇨🇿 Czechia (CZ)",example:"1 234,56 Kč",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"closed"},
        {valuta:"EUR",country:"🇩🇰 Denmark (DK)",example:"1.234,56 €",note:"National DKK",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"EUR",country:"🇪🇪 Estonia (EE)",example:"1 234,56 €",note:"",local:"et",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"EUR",country:"🇫🇮 Finland (FI)",example:"1 234,56 €",note:"",local:"fi",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"EUR",country:"🇫🇷 France (FR)",example:"1 234,56 €",note:"",local:"fr",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"EUR",country:"🇩🇪 Germany (DE)",example:"1.234,56 €",note:"",local:"de",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"USD",country:"🇺🇸 GLOBAL (EN)",example:"$1,234.56",note:"External: US$",local:"en",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"EUR",country:"🇬🇷 Greece (GR)",example:"1.234,56 €",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"HUF",country:"🇭🇺 Hungary (HU)",example:"1 234,56 Ft",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"closed"},
        {valuta:"EUR",country:"🇮🇸 Iceland (IS)",example:"1.234,56 €",note:"National ISK",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"INR",country:"🇮🇳 India (IN)",example:"₹1,23,456.78",note:"",local:"en",symPos:"Before",decSep:"DOT",tdsSep:"UNQ",status:"active"},
        {valuta:"EUR",country:"🇮🇪 Ireland (IE)",example:"€1,234.56",note:"",local:"en",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"EUR",country:"🇮🇹 Italy (IT)",example:"1.234,56 €",note:"",local:"it",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"EUR",country:"🇱🇻 Latvia (LV)",example:"1 234,56 €",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"closed"},
        {valuta:"CHF",country:"🇱🇮 Liechtenstein (LI)",example:"CHF 1’234.56",note:"CLOSED EU",local:"de",symPos:"Before",decSep:"DOT",tdsSep:"UNQ",status:"closed"},
        {valuta:"EUR",country:"🇱🇹 Lithuania (LT)",example:"1 234,56 €",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"closed"},
        {valuta:"EUR",country:"🇱🇺 Luxembourg (LU-DE)",example:"1 234,56 €",note:"",local:"de",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"EUR",country:"🇱🇺 Luxembourg (LU-FR)",example:"1 234,56 €",note:"",local:"fr",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"EUR",country:"🇲🇹 Malta (MT)",example:"€1,234.56",note:"",local:"en",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"USD",country:"🇸🇦 MENA (Arabic)",example:"US$1,234.56",note:"Internal: US$ ١٬٢٣٤٫٥٦",local:"ar",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"EUR",country:"🇲🇨 Monaco (MC)",example:"1 234,56 €",note:"CLOSED EU",local:"fr",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"closed"},
        {valuta:"EUR",country:"🇲🇪 Montenegro (ME)",example:"1.234,56 €",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"BTC",country:"🌐 N/A",example:"1.2345678 N/A",note:"Valid for all Crypto",local:"en",symPos:"After",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"EUR",country:"🇳🇱 Netherlands (NL)",example:"€ 1.234,56",note:"Nbsp after €",local:"nl",symPos:"Before",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"NZD",country:"🇳🇿 New Zealand (NZ)",example:"$1,234.56",note:"External: NZ$",local:"en-NZ",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"NOK",country:"🇳🇴 Norway (NO)",example:"1 234,56 kr",note:"",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"EUR",country:"🇵🇱 Poland (PL)",example:"1 234,56 €",note:"National PLN",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"EUR",country:"🇵🇹 Portugal (PT)",example:"1.234,56 €",note:"",local:"pt-PT",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"RON",country:"🇷🇴 Romania (RO)",example:"1.234,56 lei",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"EUR",country:"🇸🇲 San Marino (SM)",example:"1.234,56 €",note:"CLOSED EU",local:"it",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"closed"},
        {valuta:"EUR",country:"🇸🇰 Slovakia (SK)",example:"1 234,56 €",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"closed"},
        {valuta:"EUR",country:"🇸🇮 Slovenia (SI)",example:"1 234,56 €",note:"",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"active"},
        {valuta:"ZAR",country:"🇿🇦 South Africa (ZA)",example:"R1,234.56",note:"",local:"en-ZA",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"},
        {valuta:"EUR",country:"🇪🇸 Spain (ES)",example:"1.234,56€",note:"No Nbsp before €",local:"es",symPos:"After",decSep:"COM",tdsSep:"DOT",status:"active"},
        {valuta:"SEK",country:"🇸🇪 Sweden (SE)",example:"1 234,56 kr",note:"CLOSED EU",local:"en",symPos:"After",decSep:"COM",tdsSep:"SPC",status:"closed"},
        {valuta:"EUR",country:"🇨🇭 Switzerland (CH-DE)",example:"€ 1’234.56",note:"Nbsp after €",local:"de",symPos:"Before",decSep:"DOT",tdsSep:"UNQ",status:"active"},
        {valuta:"EUR",country:"🇨🇭 Switzerland (CH-FR)",example:"€ 1 234.56",note:"Nbsp after €",local:"fr",symPos:"Before",decSep:"DOT",tdsSep:"SPC",status:"active"},
        {valuta:"GBP",country:"🇬🇧 United Kingdom (UK)",example:"£1,234.56",note:"",local:"en-UK",symPos:"Before",decSep:"DOT",tdsSep:"COM",status:"active"}
    ];
    
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENT REFERENCES ---
        const D = document;
        const htmlElement = D.documentElement;
        const table = D.getElementById('glossaryTable');
        if (!table) return;

        const scrollToTopBtn = D.getElementById('scrollToTopBtn');
        const coreColsToggleBtn = D.getElementById('core-cols-toggle-btn');
        const filterBtn = D.getElementById('filter-btn');
        const filterCount = filterBtn.querySelector('.filter-count');
        const searchInput = D.getElementById('searchInput');
        const themeSwitcher = D.getElementById('theme-switcher');
        const toggleClosedBtn = D.getElementById('toggleClosedBtn');
        const quickFiltersPanel = D.getElementById('quickFiltersPanel'); // NEW
        
        const filterDropdown = D.getElementById('filter-dropdown');
        const filterList = D.getElementById('filter-list');
        
        const tableBody = D.getElementById('tableBody');
        const headers = Array.from(table.querySelectorAll('thead th'));

        // --- STATE MANAGEMENT ---
        let tableConfig = {};
        let activeFilters = {};
        let sortState = {};
        let showClosed = false;

        // --- LOCALSTORAGE HELPERS ---
        const getFromStorage = (key, defaultValue) => { try { const value = localStorage.getItem(key); return value ? JSON.parse(value) : defaultValue; } catch (e) { return defaultValue; } };
        const saveToStorage = (key, value) => localStorage.setItem(key, JSON.stringify(value));

        // --- HELPER FUNCTIONS ---
        const getBaseStyling = (item) => {
            const classes = { note: '', country: '', example: '', valutaTag: '' };
            if (item.status === 'closed') {
                classes.note = 'text-note-secondary';
                classes.country = 'text-note-secondary';
                classes.example = 'text-note-secondary';
            }
            const valuta = item.valuta.toUpperCase();
            if (item.status === 'closed' && !['AUD','CAD','USD','BRL','TRY','CHF'].includes(valuta)) {
                classes.valutaTag = 'currency-tag--note-secondary';
            } else if (['EUR', 'GBP', 'NOK'].includes(valuta)) {
                classes.valutaTag = 'currency-tag--euro-active';
            } else if (['USD', 'AUD', 'CAD', 'NZD'].includes(valuta)) {
                classes.valutaTag = 'currency-tag--dollar-family';
            } else {
                classes.valutaTag = 'currency-tag--other';
            }
            const tempNote = item.note.replace(/(WRONG|External|Internal):/g, '<span class="text-danger">$1</span>:').replace(/(BEFORE|AFTER)/g, '<span class="text-warning">$1</span>').replace(/(Nbsp)/g, '<span class="text-warning">$1</span>');
            const tempCountry = item.country.replace(/(-FR|-NL|-EN|-DE)/g, '<span class="text-warning">$1</span>');
            const tempExample = item.example.replace(/^(€|CHF)/, '<span class="text-warning">$1</span>');
            
            return { classes, tempNote, tempCountry, tempExample };
        };

        const renderTable = (data) => {
            let html = '';
            data.forEach(item => {
                const { classes, tempNote, tempCountry, tempExample } = getBaseStyling({...item});
                
                let symPosHtml = '<span></span>'; if (item.symPos === 'Before') symPosHtml = `<span class="text-danger">🅱️</span>`;
                let decSepHtml = '<span></span>'; if (item.decSep === 'DOT') decSepHtml = `<span class="text-danger">●</span>`;
                let tdsSepHtml = '<span></span>';
                switch(item.tdsSep) {
                    case 'SPC': tdsSepHtml = `<span class="text-warning">Nbsp</span>`; break;
                    case 'UNQ': tdsSepHtml = `<span class="text-unique">UNQ</span>`; break;
                    case 'DOT': tdsSepHtml = `<span class="text-success">●</span>`; break;
                }

                html += `<tr>
                    <td data-label="${tableConfig.indexToLabel[1]}"><span class="currency-tag ${classes.valutaTag}">${item.valuta}</span></td>
                    <td data-label="${tableConfig.indexToLabel[2]}"><span class="${classes.country}">${tempCountry}</span></td>
                    <td data-label="${tableConfig.indexToLabel[3]}"><span class="${classes.example}">${tempExample}</span></td>
                    <td data-label="${tableConfig.indexToLabel[4]}"><span class="${classes.note}">${tempNote}</span></td>
                    <td data-label="${tableConfig.indexToLabel[5]}">${item.local}</td>
                    <td data-label="${tableConfig.indexToLabel[6]}">${symPosHtml}</td>
                    <td data-label="${tableConfig.indexToLabel[7]}">${decSepHtml}</td>
                    <td data-label="${tableConfig.indexToLabel[8]}">${tdsSepHtml}</td>
                </tr>`;
            });
            tableBody.innerHTML = html;
        };
        
        // NEW: Custom Sort Helper
        const getValutaCategory = (item) => {
            if (item.status === 'closed') return 3; // Priority 4
            const valuta = item.valuta.toUpperCase();
            if (valuta === 'EUR') return 0; // Priority 1
            if (['USD', 'AUD', 'CAD', 'NZD'].includes(valuta)) return 1; // Priority 2
            return 2; // Priority 3 (Other)
        };
        
        const updateView = () => {
            const searchQuery = searchInput.value.toLowerCase().trim();
            
            let dataToProcess = showClosed ? currencyData : currencyData.filter(item => item.status !== 'closed');
            
            // 1. Filter
            let filteredData = dataToProcess.filter(item => {
                // Search query filter (checks multiple terms)
                const searchTerms = searchQuery.split(' ').filter(Boolean);
                if (searchTerms.length > 0 && !searchTerms.every(term => Object.values(item).join(' ').toLowerCase().includes(term))) {
                    return false;
                }

                // Dropdown filter
                for (const colId in activeFilters) {
                    const hiddenValues = activeFilters[colId];
                    if (hiddenValues && hiddenValues.length > 0) {
                        const cellValue = (colId === 'country') ? item[colId].replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]\s*/g, '').trim() : item[colId];
                        if (hiddenValues.includes(cellValue)) return false;
                    }
                }
                return true;
            });
            
            // 2. Sort
            const { columnId, direction } = sortState;
            if (columnId) {
                filteredData.sort((a, b) => {
                    if (columnId === 'valuta') {
                        const categoryA = getValutaCategory(a);
                        const categoryB = getValutaCategory(b);
                        if (categoryA !== categoryB) {
                            return direction === 'asc' ? categoryA - categoryB : categoryB - categoryA;
                        }
                    }
                    const valA = a[columnId] || ''; 
                    const valB = b[columnId] || '';
                    const compareResult = valA.localeCompare(valB, 'en', {numeric: true});
                    return direction === 'asc' ? compareResult : -compareResult;
                });
            }

            renderTable(filteredData);
            updateFilterButtonState();
            updateSortHeaders();
        };

        // --- UI UPDATE FUNCTIONS ---
        const toggleCoreColumnsVisibility = (isVisible) => { 
            let style = D.getElementById('core-column-styles');
            if(!style) { style = D.createElement('style'); style.id = 'core-column-styles'; D.head.appendChild(style); }
            const css = tableConfig.coreColumnIds.map(id => {
                const index = tableConfig.columnIdToIndex[id];
                const displayRule = isVisible ? '' : 'display: none !important;';
                return `th[data-column-index="${index}"], td:nth-child(${index}) { ${displayRule} } @media (max-width: 820px) { td:nth-child(${index}) { ${displayRule} } }`;
            }).join('');
            style.textContent = css;
            coreColsToggleBtn.dataset.state = isVisible ? 'visible' : 'hidden';
        };
        
        const updateToggleClosedBtnState = () => { toggleClosedBtn.dataset.state = showClosed ? 'shown' : 'hidden'; };
        const updateFilterButtonState = () => { 
            const activeGroupCount = Object.keys(activeFilters).filter(key => activeFilters[key]?.length > 0).length;
            filterBtn.classList.toggle('is-active-filter', activeGroupCount > 0);
            filterCount.textContent = activeGroupCount > 0 ? activeGroupCount : '';
        };
        
        const updateSortHeaders = () => {
            headers.forEach(h => { h.classList.remove('is-active'); h.removeAttribute('aria-sort'); h.querySelector('.sort-indicator').textContent = '↕'; });
            const activeHeader = headers[tableConfig.columnIdToIndex[sortState.columnId] - 1];
            if(activeHeader){
                activeHeader.classList.add('is-active');
                activeHeader.setAttribute('aria-sort', sortState.direction === 'asc' ? 'ascending' : 'descending');
                activeHeader.querySelector('.sort-indicator').textContent = sortState.direction === 'asc' ? '▲' : '▼';
            }
        };

        const populateFilterDropdown = () => {
            filterList.replaceChildren();
            const resetLi = D.createElement('li'); resetLi.innerHTML = `<button id="filter-reset-all">Reset All Filters</button>`;
            filterList.append(resetLi);

            tableConfig.filterableColumnIds.forEach(colId => {
                const colIndex = tableConfig.columnIdToIndex[colId];
                const headerText = tableConfig.indexToLabel[colIndex];
                const accordionItem = D.createElement('li'); accordionItem.className = 'filter-accordion-item';
                const accordionHeader = D.createElement('button'); accordionHeader.className = 'filter-accordion-header';
                accordionHeader.innerHTML = `<h3>${headerText}</h3><span class="filter-accordion-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></span>`;
                const accordionContent = D.createElement('div'); accordionContent.className = 'filter-accordion-content';
                const contentList = D.createElement('ul'); contentList.className = 'filter-group-list';

                const getVal = (item, id) => (id === 'country') ? item[id].replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]\s*/g, '').trim() : item[id];
                let uniqueValues = [...new Set(currencyData.map(item => getVal(item, colId)))].filter(v => v && v.trim() !== '' && v !== 'N/A').sort((a,b) => a.localeCompare(b, 'en', { numeric: true }));
                const hiddenValues = activeFilters[colId] || [];
                const isGroupUnchecked = uniqueValues.length > 0 && uniqueValues.every(val => hiddenValues.includes(val));

                const selectAllLi = D.createElement('li'); selectAllLi.className = 'filter-group-select-all filter-value-item';
                selectAllLi.innerHTML = `<label><input type="checkbox" data-col-id="${colId}" ${isGroupUnchecked ? '' : 'checked'}> Select All</label>`;
                contentList.append(selectAllLi);

                uniqueValues.forEach(value => {
                    const itemLi = D.createElement('li'); itemLi.className = 'filter-value-item';
                    itemLi.innerHTML = `<label><input type="checkbox" data-col-id="${colId}" data-value="${value}" ${!hiddenValues.includes(value) ? 'checked' : ''}> ${value}</label>`;
                    contentList.append(itemLi);
                });
                accordionContent.append(contentList);
                accordionItem.append(accordionHeader, accordionContent);
                filterList.append(accordionItem);
            });
        };
        
        const init = () => {
            const columnIdToIndex = {}; const indexToColumnId = {}; const coreColumnIds = []; const indexToLabel = {};
            headers.forEach((th, i) => {
                const index = i + 1; const id = th.dataset.columnId; if (!id) return;
                columnIdToIndex[id] = index; indexToColumnId[index] = id; indexToLabel[index] = th.innerText.replace(/\n/g, ' ');
                if (th.dataset.isCore === 'true') { coreColumnIds.push(id); }
            });
            tableConfig = { headers, columnIdToIndex, indexToColumnId, coreColumnIds, indexToLabel, filterableColumnIds: ['valuta', 'country', 'note', 'local', 'symPos', 'decSep', 'tdsSep'], defaultSortState: { columnId: 'valuta', direction: 'asc' } }; // MODIFIED: Default sort by valuta

            activeFilters = getFromStorage('activeFilters', {});
            const coreColumnsVisible = getFromStorage('coreColumnsVisible', true);
            const savedTheme = getFromStorage('theme', 'dark');
            sortState = getFromStorage('sortState', tableConfig.defaultSortState);
            showClosed = getFromStorage('showClosedState', false);

            const updateThemeUI = (theme) => { htmlElement.setAttribute('data-theme', theme); themeSwitcher.setAttribute('aria-checked', theme === 'light' ? 'true' : 'false'); };
            updateThemeUI(savedTheme);
            toggleCoreColumnsVisibility(coreColumnsVisible);
            updateToggleClosedBtnState();
            
            // --- EVENT LISTENERS ---
            scrollToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            themeSwitcher.addEventListener('click', () => { const newTheme = themeSwitcher.getAttribute('aria-checked') === 'true' ? 'dark' : 'light'; updateThemeUI(newTheme); saveToStorage('theme', newTheme); });
            coreColsToggleBtn.addEventListener('click', () => { const isVisible = coreColsToggleBtn.dataset.state !== 'visible'; toggleCoreColumnsVisibility(isVisible); saveToStorage('coreColumnsVisible', isVisible); });
            toggleClosedBtn.addEventListener('click', () => { showClosed = !showClosed; saveToStorage('showClosedState', showClosed); updateToggleClosedBtnState(); updateView(); });

            headers.forEach(header => { 
                header.addEventListener('click', () => {
                    const colId = header.dataset.columnId; if (!colId) return;
                    sortState.direction = (sortState.columnId === colId && sortState.direction === 'asc') ? 'desc' : 'asc';
                    sortState.columnId = colId;
                    saveToStorage('sortState', sortState);
                    updateView();
                });
            });
            
            filterBtn.addEventListener('click', (e) => { e.stopPropagation(); if (!filterDropdown.classList.contains('is-open')) { populateFilterDropdown(); } filterDropdown.classList.toggle('is-open'); });
            
            filterList.addEventListener('click', e => {
                const accordionHeader = e.target.closest('.filter-accordion-header');
                const checkboxLabel = e.target.closest('label');
                const resetBtn = e.target.closest('#filter-reset-all');

                if (accordionHeader) { const item = accordionHeader.parentElement; item.classList.toggle('is-open'); accordionHeader.nextElementSibling.style.maxHeight = item.classList.contains('is-open') ? accordionHeader.nextElementSibling.scrollHeight + 'px' : '0px'; return; }
                if (resetBtn) { activeFilters = {}; saveToStorage('activeFilters', activeFilters); populateFilterDropdown(); updateView(); return; }
                if (checkboxLabel && e.target.type === 'checkbox') {
                    const checkbox = e.target; const colId = checkbox.dataset.colId; if (!activeFilters[colId]) activeFilters[colId] = [];
                    if (checkbox.closest('.filter-group-select-all')) {
                        const allValues = Array.from(checkbox.closest('.filter-group-list').querySelectorAll(`input[data-col-id="${colId}"][data-value]`)).map(cb => cb.dataset.value);
                        activeFilters[colId] = checkbox.checked ? [] : [...allValues];
                        checkbox.closest('.filter-group-list').querySelectorAll(`input[data-col-id="${colId}"][data-value]`).forEach(cb => cb.checked = checkbox.checked);
                    } else {
                        const value = checkbox.dataset.value;
                        if (checkbox.checked) { activeFilters[colId] = activeFilters[colId].filter(item => item !== value); } 
                        else { if (!activeFilters[colId].includes(value)) activeFilters[colId].push(value); }
                        const allCheckboxes = Array.from(checkbox.closest('.filter-group-list').querySelectorAll(`input[data-col-id="${colId}"][data-value]`));
                        const selectAll = checkbox.closest('.filter-group-list').querySelector(`.filter-group-select-all input[data-col-id="${colId}"]`);
                        if (selectAll) { selectAll.checked = allCheckboxes.every(cb => cb.checked); }
                    }
                    if (activeFilters[colId]?.length === 0) delete activeFilters[colId];
                    saveToStorage('activeFilters', activeFilters);
                    updateView();
                }
            });
            
            // MODIFIED: Search input listener
            searchInput.addEventListener('input', () => {
                quickFiltersPanel.querySelectorAll('.quick-filter-btn').forEach(b => b.classList.remove('is-active'));
                updateView();
            });
            
            // NEW: Quick filters listener
            quickFiltersPanel.addEventListener('click', e => {
                const btn = e.target.closest('.quick-filter-btn');
                if (!btn) return;

                quickFiltersPanel.querySelectorAll('.quick-filter-btn').forEach(b => { if (b !== btn) b.classList.remove('is-active'); });

                if (btn.classList.contains('is-active')) {
                    btn.classList.remove('is-active');
                    searchInput.value = '';
                } else {
                    btn.classList.add('is-active');
                    searchInput.value = btn.dataset.filterValue;
                }
                
                activeFilters = {};
                saveToStorage('activeFilters', activeFilters);
                updateView();
            });

            D.addEventListener('click', (e) => { if (!filterDropdown.contains(e.target) && !filterBtn.contains(e.target)) { filterDropdown.classList.remove('is-open'); } });
            
            updateView();
        };
        
        init();
    });
})();
</script>

</body>
</html>
